AI ORCHESTRATOR – AUDIT TECHNIQUE (V4)
Date: 2025-12-25

1. Périmètre et méthode
- Lecture exhaustive du dépôt (backend, frontend, docs, scripts de déploiement, Dockerfiles).
- Analyse des modules critiques: `security.py`, `auth.py`, `main.py`, `engine.py`, `tools/*`, `frontend/index.html`, `docker-compose*.yml`.
- Vérification de la présence d’artefacts sensibles (`backend/.env`, `backend/venv`, backups multiples).
- Tentative d’exécution des tests via l’environnement embarqué (`backend/venv/bin/python -m pytest tests -q`).

2. Constats détaillés
2.1 Gravité critique
1) Refresh tokens attribués à l’admin (`backend/main.py:600-666`).
   • `create_refresh_token` est invoqué avec `user_id=1` pour toute connexion.
   • `/api/auth/refresh` recharge `get_user("admin")` quel que soit le token fourni et attend le token sous forme de simple paramètre, contrairement au JSON annoncé.
   • Risque: toute session prolongée hérite des scopes admin. Les utilisateurs non-admin ne peuvent pas maintenir leurs privilèges restreints.

2) Sécurité des outils by-passée (`backend/tools/__init__.py:33-89`).
   • Seuls `execute_command`, `read_file`, `write_file` reçoivent `security_validator` et `audit_logger`.
   • Tous les autres handlers (Docker, système, réseau, Git) exécutent des commandes brutes (`docker`, `systemctl`, `git`), parfois même `sudo systemctl` (`backend/tools/system_tools.py:69-86`).
   • Risque: possibilité d’exécuter des opérations sensibles hors whitelist, annulant la protection “zéro shell injection”.

2.2 Gravité élevée
3) Commandes incompatibles avec `run_command_async` (`backend/utils/async_subprocess.py:33-84`).
   • L’exécuteur interdit le shell, mais les outils utilisent encore pipes/redirections/`cd &&` (`system_tools.py:33-101`, `file_tools.py:106-158`, `docker_tools.py:33-120`, `network_tools.py:91-105`).
   • Résultat: erreurs silencieuses, métriques systèmes et actions Docker souvent vides.

4) Frontend WebSocket désaligné (`frontend/index.html:269-357` vs `backend/main.py:901-1015`).
   • L’évènement `conversation_created` n’est pas géré ⇒ `currentConversationId` reste `null` et chaque message crée une nouvelle conversation.
   • `loadConversations()` attend un tableau alors que l’API renvoie `{ "conversations": [...] }` ⇒ la barre latérale reste vide.
   • L’onglet Docker appelle `/api/docker/status` inexistant; les fichiers sont envoyés inline (`files: attachedFiles`) au lieu de passer par `/api/upload` pour obtenir des `file_ids`.
   • Impact: flux temps réel inutilisable (pas d’historique, pas d’upload, pas de stats Docker).

5) Déploiement risqué & mémoire inactive (`docker-compose.yml:1-40`, `backend/auto_learn.py:53-63`, `backend/tools/memory_tools.py:27-52`).
   • Volume `/home/lalpha:/home/lalpha` monté en lecture/écriture dans le conteneur backend ⇒ exposition intégrale du home (clés SSH, dépôts privés, secrets).
   • Aucun service ChromaDB n’est déployé alors que les modules mémoire se connectent à `chromadb:8000` en dur ⇒ toute fonctionnalité mémoire échoue.

2.3 Gravité moyenne
6) `analyze_image` plante (`backend/tools/ai_tools.py:23-73`).
   • Le handler suppose `uploaded_files` comme dict mais reçoit une liste d’objets (`backend/main.py:901-915`). Un appel vision déclenche `AttributeError`.

7) Suppression de conversations incomplète (`backend/main.py:473-481`).
   • Les entrées DB `uploads` sont supprimées mais les fichiers physiques restent dans `data/uploads`, sans log audit.

8) Secret JWT loggé (`backend/auth.py:26-35`).
   • Le démarrage imprime « Loaded SECRET_KEY starting with … » ⇒ fuite partielle dans les journaux.

9) Config mémoire rigide et non documentée (`backend/auto_learn.py:53-63`, `memory_tools.py:27-52`).
   • Host/port codés en dur; les variables `.env` ne sont pas utilisées.

10) Hygiène du dépôt insuffisante.
   • Présence de `backend/.env`, `backend/venv/`, multiples backups versionnés (`backend/_backups/*`, `frontend/*.backup`). Risques de fuite et difficultés de reproduction.

3. Tests
- Commande: `backend/venv/bin/python -m pytest tests -q`.
- Résultat: `ModuleNotFoundError: No module named 'pytest'` (le venv commité n’inclut pas pytest/pytest-asyncio).
- Conséquence: impossible de valider automatiquement les corrections sans recréer l’environnement (recommandé: supprimer `backend/venv/`, documenter l’installation, ajouter une CI qui installe les dépendances puis lance pytest).

4. Recommandations synthétiques
1) Corriger la gestion des refresh tokens (stockage du `user_id`, endpoints JSON, respect des scopes, journalisation) et supprimer toute trace du secret JWT dans les logs.
2) Propager `security_validator`/`audit_logger` à tous les handlers `tools/*`, supprimer `sudo`, restreindre les services/containers autorisés et ajouter des tests de régression.
3) Adapter les commandes aux contraintes de `run_command_async` ou introduire un exécuteur sécurisé validé par le module `security`.
4) Ré-aligner le frontend: traitement des événements WS, format des conversations, implémentation d’un bouton upload qui appelle `/api/upload`, ajout d’un endpoint `/api/docker/status` ou retrait de l’onglet.
5) Durcir le déploiement: limiter les montages sensibles, ajouter un service ChromaDB (ou rendre l’hôte configurable via `.env`), documenter les variables critiques.
6) Hygiène du dépôt: retirer `backend/venv` et `.env` du SCM, archiver les backups en dehors du repo, ajouter un workflow CI/pytest.
7) Gérer la suppression physique des fichiers uploadés lors d’un `delete_conversation`, avec log dans `audit_log`.

