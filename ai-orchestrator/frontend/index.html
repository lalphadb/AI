<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Orchestrator v4.0</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <!-- Markdown & Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Tailwind (via CDN for simplicity in this setup, though a build step is better for prod) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        primary: {
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Markdown Styles */
        .markdown-body {
            color: #e2e8f0;
            line-height: 1.7;
            font-size: 1rem;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: #f8fafc;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            font-weight: 700;
            line-height: 1.3;
        }
        .markdown-body h1 { font-size: 1.75em; }
        .markdown-body h2 { font-size: 1.4em; border-bottom: 1px solid #334155; padding-bottom: 0.3em; color: #60a5fa; }
        .markdown-body h3 { font-size: 1.2em; color: #93c5fd; }
        .markdown-body p { margin-bottom: 1.2em; }
        .markdown-body ul, .markdown-body ol { margin-bottom: 1.2em; padding-left: 1.5em; }
        .markdown-body li { margin-bottom: 0.5em; }
        .markdown-body strong { color: #fff; font-weight: 600; }
        .markdown-body code {
            background-color: #1e293b;
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            color: #e2e8f0;
        }
        .markdown-body pre {
            background-color: #1e293b;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1em;
            border: 1px solid #334155;
        }
        .markdown-body pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
            font-size: 0.85em;
        }
        .markdown-body blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            color: #94a3b8;
            margin-bottom: 1em;
            font-style: italic;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #334155;
            padding: 0.5em;
            text-align: left;
        }
        .markdown-body th {
            background-color: #1e293b;
            font-weight: 600;
        }
        .markdown-body a {
            color: #3b82f6;
            text-decoration: none;
        }
        .markdown-body a:hover {
            text-decoration: underline;
        }

        /* Thinking Accordion Animation */
        .thinking-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .thinking-content.open {
            max-height: 500px; /* Arbitrary large height */
            opacity: 1;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden selection:bg-primary-500/30">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col transition-all duration-300 transform translate-x-0">
        <!-- Header -->
        <div class="p-4 border-b border-slate-800 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center">
                    <i class="ri-robot-2-line text-white"></i>
                </div>
                <span class="font-bold text-slate-100">Orchestrator</span>
            </div>
            <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-white">
                <i class="ri-menu-fold-line"></i>
            </button>
        </div>

        <!-- New Chat Button -->
        <div class="p-4">
            <button onclick="startNewChat()" class="w-full bg-primary-600 hover:bg-primary-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors font-medium shadow-lg shadow-primary-600/20">
                <i class="ri-add-line"></i>
                Nouvelle Chat
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto px-2 space-y-1">
            <!-- Sidebar Stats -->
            <div class="px-2 py-4 mb-2 border-b border-slate-800">
                <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Syst√®me</div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-400"><i class="ri-cpu-line mr-2"></i>CPU</span>
                        <span id="sidebar-cpu" class="font-mono text-slate-200">--%</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-400"><i class="ri-database-2-line mr-2"></i>RAM</span>
                        <span id="sidebar-ram" class="font-mono text-slate-200">--GB</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-400"><i class="ri-dashboard-line mr-2"></i>GPU</span>
                        <span id="sidebar-gpu" class="font-mono text-slate-200">--%</span>
                    </div>
                </div>
            </div>

            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider px-2 mt-4 mb-2">Conversations</div>
            <div id="conversations-list" class="space-y-1">
                <!-- Conversations will be injected here -->
            </div>
        </nav>

        <!-- User Profile / Settings -->
        <div class="p-4 border-t border-slate-800 bg-slate-900/50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold">
                    LA
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-white truncate">Lalpha</div>
                    <div class="text-xs text-slate-500 truncate">Admin</div>
                </div>
                <button onclick="doLogout()" class="text-slate-400 hover:text-red-400 transition-colors">
                    <i class="ri-logout-box-r-line"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-950 relative">
        <!-- Top Bar -->
        <header class="h-14 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-950/80 backdrop-blur z-10">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white focus:outline-none">
                    <i class="ri-menu-line text-xl"></i>
                </button>
                <div class="h-6 w-px bg-slate-800 mx-1"></div>
                <select id="model-select" class="bg-transparent text-sm text-slate-300 focus:outline-none cursor-pointer hover:text-white">
                    <option value="auto">ü§ñ Auto (Recommand√©)</option>
                    <option value="qwen2.5-coder:32b">üíª Qwen 2.5 Coder</option>
                    <option value="deepseek-coder:33b">üß† DeepSeek Coder</option>
                    <option value="llama3.2-vision:11b">üëÅÔ∏è Llama Vision</option>
                </select>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- System Stats (Mini) -->
                <div class="hidden md:flex items-center gap-4 text-xs font-mono text-slate-400">
                    <div class="flex items-center gap-1.5" title="CPU Usage">
                        <i class="ri-cpu-line"></i>
                        <span id="cpu-val">--%</span>
                    </div>
                    <div class="flex items-center gap-1.5" title="RAM Usage">
                        <i class="ri-database-2-line"></i>
                        <span id="ram-val">--/--GB</span>
                    </div>
                    <div class="flex items-center gap-1.5" title="GPU Usage">
                        <i class="ri-dashboard-line"></i>
                        <span id="gpu-val">--%</span>
                    </div>
                </div>
                
                <div class="h-6 w-px bg-slate-800 mx-1 hidden md:block"></div>
                
                <button onclick="toggleActivityPanel()" class="text-slate-400 hover:text-primary-400 transition-colors relative">
                    <i class="ri-file-list-3-line text-xl"></i>
                    <span id="activity-badge" class="absolute -top-1 -right-1 w-2 h-2 bg-primary-500 rounded-full hidden"></span>
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 scroll-smooth">
            <div class="max-w-3xl mx-auto space-y-6 pb-4" id="messages">
                <!-- Welcome Message -->
                <div class="flex flex-col items-center justify-center h-full text-center space-y-4 mt-20 opacity-50">
                    <div class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mb-4">
                        <i class="ri-robot-2-line text-3xl text-slate-400"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-slate-200">Comment puis-je vous aider aujourd'hui ?</h2>
                    <p class="text-sm text-slate-500 max-w-md">
                        Je peux analyser votre infrastructure, g√©rer vos conteneurs Docker, 
                        auditer votre code ou ex√©cuter des commandes syst√®me.
                    </p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-slate-800 bg-slate-950">
            <div class="max-w-3xl mx-auto">
                <!-- Attachments Preview -->
                <div id="attachments-preview" class="flex flex-wrap gap-2 mb-2 empty:hidden"></div>
                
                <div class="relative bg-slate-900 rounded-xl border border-slate-800 focus-within:border-primary-500/50 focus-within:ring-1 focus-within:ring-primary-500/50 transition-all shadow-sm">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Posez une question ou demandez une action..." 
                        class="w-full bg-transparent text-slate-200 p-4 pr-12 resize-none focus:outline-none max-h-48 text-sm leading-relaxed"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    ></textarea>
                    
                    <div class="absolute bottom-2 right-2 flex items-center gap-1">
                        <button onclick="document.getElementById('file-input').click()" class="p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-800 transition-colors" title="Joindre un fichier">
                            <i class="ri-attachment-2"></i>
                        </button>
                        <button id="send-btn" onclick="sendMessage()" class="p-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg transition-colors shadow-lg shadow-primary-600/20 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ri-send-plane-fill"></i>
                        </button>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <p class="text-xs text-slate-600">AI Orchestrator peut faire des erreurs. V√©rifiez les actions critiques.</p>
                </div>
            </div>
        </div>
        
        <input type="file" id="file-input" class="hidden" multiple>
    </main>

    <!-- Activity Panel (Right Drawer) -->
    <aside id="activity-panel" class="w-96 bg-slate-900 border-l border-slate-800 transform translate-x-full transition-transform duration-300 absolute right-0 top-14 bottom-0 z-20 shadow-2xl flex flex-col">
        <div class="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
            <h3 class="font-semibold text-slate-200">Activit√© Syst√®me</h3>
            <button onclick="toggleActivityPanel()" class="text-slate-400 hover:text-white">
                <i class="ri-close-line text-xl"></i>
            </button>
        </div>
        
        <!-- Tabs -->
        <div class="flex border-b border-slate-800">
            <button onclick="switchTab('logs')" class="flex-1 py-2 text-xs font-medium text-primary-400 border-b-2 border-primary-500 bg-slate-800/50">Logs</button>
            <button onclick="switchTab('docker')" class="flex-1 py-2 text-xs font-medium text-slate-400 hover:text-slate-200">Docker</button>
            <button onclick="switchTab('files')" class="flex-1 py-2 text-xs font-medium text-slate-400 hover:text-slate-200">Fichiers</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="activity-content">
            <!-- Logs Tab Content -->
            <div id="tab-logs" class="space-y-3">
                <!-- Logs will be injected here -->
            </div>
            
            <!-- Docker Tab Content -->
            <div id="tab-docker" class="hidden grid grid-cols-1 gap-2">
                <!-- Docker status will be injected here -->
            </div>

            <!-- Files Tab Content -->
            <div id="tab-files" class="hidden font-mono text-xs text-slate-400">
                <!-- File tree will be injected here -->
            </div>
        </div>
    </aside>

    <!-- Scripts -->
    <script>
        // Configuration
        const API_URL = window.location.origin; // Auto-detect
        let authToken = localStorage.getItem('auth_token');
        let ws = null;
        let currentConversationId = null;
        let attachedFiles = [];
        let isProcessing = false;

        // Initialize Marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // ==========================================
        // UI FUNCTIONS
        // ==========================================
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function toggleActivityPanel() {
            const panel = document.getElementById('activity-panel');
            const isOpen = !panel.classList.contains('translate-x-full');
            
            if (isOpen) {
                panel.classList.add('translate-x-full');
            } else {
                panel.classList.remove('translate-x-full');
                document.getElementById('activity-badge').classList.add('hidden');
            }
        }

        function switchTab(tabName) {
            // Update tabs UI
            const tabs = document.querySelectorAll('#activity-panel button[onclick^="switchTab"]');
            tabs.forEach(t => {
                if (t.getAttribute('onclick').includes(tabName)) {
                    t.className = 'flex-1 py-2 text-xs font-medium text-primary-400 border-b-2 border-primary-500 bg-slate-800/50';
                } else {
                    t.className = 'flex-1 py-2 text-xs font-medium text-slate-400 hover:text-slate-200';
                }
            });

            // Show content
            document.getElementById('tab-logs').classList.add('hidden');
            document.getElementById('tab-docker').classList.add('hidden');
            document.getElementById('tab-files').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            if (tabName === 'docker') loadDockerStatus();
            if (tabName === 'files') loadFileTree();
        }

        // ==========================================
        // CHAT LOGIC
        // ==========================================

        function addMessage(role, content, isThinking = false) {
            const messagesContainer = document.getElementById('messages');
            
            // Remove welcome message if it exists
            if (messagesContainer.querySelector('.text-center')) {
                messagesContainer.innerHTML = '';
            }

            const msgDiv = document.createElement('div');
            msgDiv.className = `flex gap-4 ${role === 'user' ? 'flex-row-reverse' : ''} animate-fade-in`;
            
            const avatar = role === 'user' 
                ? `<div class="w-8 h-8 rounded-full bg-slate-700 flex-shrink-0 flex items-center justify-center text-xs font-bold text-slate-300">LA</div>`
                : `<div class="w-8 h-8 rounded-lg bg-primary-600/20 flex-shrink-0 flex items-center justify-center"><i class="ri-robot-2-line text-primary-400"></i></div>`;

            const bubbleClass = role === 'user'
                ? 'bg-primary-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 max-w-[80%]'
                : 'bg-slate-900 border border-slate-800 rounded-2xl rounded-tl-sm px-6 py-4 w-full max-w-3xl shadow-sm';

            let innerContent = '';
            
            if (role === 'assistant') {
                // Assistant message structure with Thinking Accordion
                innerContent = `
                    <div class="thinking-section mb-4 hidden">
                        <button onclick="toggleThinking(this)" class="flex items-center gap-2 text-xs font-mono text-slate-500 hover:text-slate-300 transition-colors w-full text-left">
                            <i class="ri-arrow-right-s-line transition-transform"></i>
                            <span class="thinking-header">Thinking Process</span>
                            <span class="animate-pulse ml-auto status-dot w-2 h-2 rounded-full bg-primary-500"></span>
                        </button>
                        <div class="thinking-content mt-2 pl-4 border-l border-slate-800 text-xs font-mono text-slate-400 space-y-1">
                            <!-- Steps go here -->
                        </div>
                    </div>
                    <div class="markdown-body">${marked.parse(content)}</div>
                `;
            } else {
                // User message (plain text)
                innerContent = `<div class="whitespace-pre-wrap">${content}</div>`;
            }

            msgDiv.innerHTML = `
                ${avatar}
                <div class="${bubbleClass}">
                    ${innerContent}
                </div>
            `;

            messagesContainer.appendChild(msgDiv);
            
            // Scroll to bottom
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return msgDiv;
        }

        function toggleThinking(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('i');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('open');
                icon.style.transform = 'rotate(90deg)';
            }
        }

        function updateThinkingStep(msgDiv, stepContent, type = 'step') {
            const thinkingSection = msgDiv.querySelector('.thinking-section');
            const thinkingContent = msgDiv.querySelector('.thinking-content');
            const thinkingHeader = msgDiv.querySelector('.thinking-header');
            
            if (!thinkingSection) return;
            
            thinkingSection.classList.remove('hidden');
            
            // Auto-open on first step
            if (type === 'thinking' && !thinkingContent.classList.contains('open')) {
                toggleThinking(thinkingSection.querySelector('button'));
            }

            const stepDiv = document.createElement('div');
            
            if (type === 'thinking') {
                thinkingHeader.textContent = stepContent; // "It√©ration X..."
            } else if (type === 'tool') {
                stepDiv.className = 'text-primary-400';
                stepDiv.innerHTML = `<i class="ri-tools-line mr-1"></i> ${stepContent}`;
                thinkingContent.appendChild(stepDiv);
            } else if (type === 'result') {
                stepDiv.className = 'text-green-400/80 truncate';
                stepDiv.innerHTML = `<i class="ri-check-line mr-1"></i> ${stepContent}`;
                thinkingContent.appendChild(stepDiv);
            } else {
                // Raw thought
                stepDiv.textContent = stepContent;
                thinkingContent.appendChild(stepDiv);
            }
            
            // Auto scroll thinking content
            thinkingContent.scrollTop = thinkingContent.scrollHeight;
        }

        function finalizeMessage(msgDiv, finalContent) {
            const markdownBody = msgDiv.querySelector('.markdown-body');
            if (markdownBody) {
                // Fix double escaped newlines and other common formatting issues
                let cleanContent = finalContent
                    .replace(/\\n/g, '\n')  // Replace literal \n with actual newline
                    .replace(/\\"/g, '"')   // Replace escaped quotes
                    .replace(/\\'/g, "'");  // Replace escaped single quotes
                
                // Force newlines before headers if missing
                cleanContent = cleanContent.replace(/([^\n])(#{1,6}\s)/g, '$1\n\n$2');
                
                // Force newlines before lists
                cleanContent = cleanContent.replace(/([^\n])(\n- )/g, '$1\n$2');
                
                markdownBody.innerHTML = marked.parse(cleanContent);
                // Highlight code blocks
                markdownBody.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
            
            // Stop pulsing dot
            const dot = msgDiv.querySelector('.status-dot');
            if (dot) dot.classList.remove('animate-pulse', 'bg-primary-500');
            if (dot) dot.classList.add('bg-slate-700');
            
            // Collapse thinking if it was open (optional, maybe keep it open if user opened it?)
            // Let's keep it as is.
        }

        // ==========================================
        // WEBSOCKET & API
        // ==========================================

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            // UI Updates
            isProcessing = true;
            document.getElementById('send-btn').disabled = true;
            input.value = '';
            input.style.height = 'auto';
            
            addMessage('user', message);
            
            // Create placeholder for assistant response
            const assistantMsgDiv = addMessage('assistant', '...');
            
            // Send via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                const payload = {
                    message: message,
                    model: document.getElementById('model-select').value,
                    conversation_id: currentConversationId,
                    file_ids: attachedFiles
                };
                ws.send(JSON.stringify(payload));
                
                // Store reference to current message div for updates
                window.currentMsgDiv = assistantMsgDiv;
                
                // Clear attachments
                attachedFiles = [];
                document.getElementById('attachments-preview').innerHTML = '';
            } else {
                finalizeMessage(assistantMsgDiv, "‚ùå Erreur: WebSocket non connect√©. Veuillez rafra√Æchir la page.");
                isProcessing = false;
                document.getElementById('send-btn').disabled = false;
            }
        }

        function connectWebSocket() {
            if (!authToken) return; // Wait for auth
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/chat?token=${authToken}`);
            
            ws.onopen = () => {
                console.log('üü¢ WS Connected');
                addLog('success', 'Syst√®me', 'Connexion √©tablie');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = (event) => {
                console.log('üî¥ WS Disconnected', event.code, event.reason);
                // Si le code est 1006 (abnormal) ou si la connexion est rejet√©e imm√©diatement
                // On ne peut pas lire le code HTTP 403 directement via l'API WebSocket JS standard
                // Mais si la connexion √©choue juste apr√®s l'ouverture, c'est souvent l'auth.
                
                // Tentative de reconnexion
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WS Error:', error);
                // Si erreur imm√©diate, v√©rifier le token
                verifyTokenAndLogoutIfInvalid();
            };
        }

        async function verifyTokenAndLogoutIfInvalid() {
            try {
                const res = await fetch(`${API_URL}/api/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.status === 401 || res.status === 403) {
                    console.log("Token invalide d√©tect√©, d√©connexion...");
                    doLogout();
                }
            } catch (e) {
                console.error("Erreur v√©rification token:", e);
            }
        }

        function handleWebSocketMessage(data) {
            const msgDiv = window.currentMsgDiv;
            if (!msgDiv && data.type !== 'conversation_created') return;

            switch (data.type) {
                case 'conversation_created':
                    currentConversationId = data.conversation_id;
                    loadConversations();
                    break;
                    
                case 'thinking':
                    updateThinkingStep(msgDiv, data.message, 'thinking');
                    break;
                    
                case 'step':
                    // Filter out "THINK:" prefixes if present to avoid duplication
                    let content = data.content;
                    if (content.startsWith('THINK:')) content = content.substring(6).trim();
                    updateThinkingStep(msgDiv, content, 'step');
                    break;
                    
                case 'tool':
                    updateThinkingStep(msgDiv, `${data.tool}(${JSON.stringify(data.params)})`, 'tool');
                    addLog('info', 'Tool', `Ex√©cution de ${data.tool}`);
                    break;
                    
                case 'result':
                    updateThinkingStep(msgDiv, `R√©sultat: ${data.result?.substring(0, 100)}...`, 'result');
                    break;
                    
                case 'complete':
                    finalizeMessage(msgDiv, data.answer);
                    isProcessing = false;
                    document.getElementById('send-btn').disabled = false;
                    window.currentMsgDiv = null;
                    break;
                    
                case 'error':
                    finalizeMessage(msgDiv, `‚ùå Erreur: ${data.message}`);
                    isProcessing = false;
                    document.getElementById('send-btn').disabled = false;
                    break;
            }
        }

        // ==========================================
        // AUTH & INIT
        // ==========================================

        async function checkAuth() {
            // Simple check - in real app, verify token validity
            if (!authToken) {
                // Show login modal or redirect (simplified here)
                const password = prompt("Mot de passe admin:");
                if (password) {
                    try {
                        const formData = new FormData();
                        formData.append('username', 'admin');
                        formData.append('password', password);
                        
                        const res = await fetch(`${API_URL}/api/auth/login`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            authToken = data.access_token;
                            localStorage.setItem('auth_token', authToken);
                            initApp();
                        } else {
                            alert('Erreur authentification');
                        }
                    } catch (e) {
                        console.error(e);
                    }
                }
            } else {
                initApp();
            }
        }

        function doLogout() {
            localStorage.removeItem('auth_token');
            location.reload();
        }

        function initApp() {
            connectWebSocket();
            loadConversations();
            loadSystemStats();
            setInterval(loadSystemStats, 5000);
        }

        // ==========================================
        // HELPERS
        // ==========================================

        async function authFetch(url, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers['Authorization'] = `Bearer ${authToken}`;
            return fetch(url, options);
        }

        async function loadConversations() {
            try {
                const res = await authFetch(`${API_URL}/api/conversations`);
                const convs = await res.json();
                const list = document.getElementById('conversations-list');
                list.innerHTML = convs.map(c => `
                    <div onclick="loadConversation('${c.id}')" class="px-2 py-2 mx-2 rounded-md hover:bg-slate-800 cursor-pointer text-sm text-slate-400 hover:text-slate-200 truncate transition-colors ${c.id === currentConversationId ? 'bg-slate-800 text-white' : ''}">
                        ${c.title || 'Nouvelle conversation'}
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function startNewChat() {
            currentConversationId = null;
            document.getElementById('messages').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-4 mt-20 opacity-50">
                    <div class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mb-4">
                        <i class="ri-robot-2-line text-3xl text-slate-400"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-slate-200">Nouvelle conversation</h2>
                </div>
            `;
        }

        async function loadSystemStats() {
            try {
                const res = await authFetch(`${API_URL}/api/stats`);
                const data = await res.json();
                
                // Header stats
                document.getElementById('cpu-val').textContent = `${data.cpu?.percent || 0}%`;
                document.getElementById('ram-val').textContent = `${data.memory?.used_gb || 0}/${data.memory?.total_gb || 64}GB`;
                document.getElementById('gpu-val').textContent = `${data.gpu?.percent || 0}%`;

                // Sidebar stats
                const sidebarCpu = document.getElementById('sidebar-cpu');
                if (sidebarCpu) {
                    sidebarCpu.textContent = `${data.cpu?.percent || 0}%`;
                    sidebarCpu.className = `font-mono ${data.cpu?.percent > 80 ? 'text-red-400' : 'text-slate-200'}`;
                    
                    document.getElementById('sidebar-ram').textContent = `${data.memory?.used_gb || 0}GB`;
                    document.getElementById('sidebar-gpu').textContent = `${data.gpu?.percent || 0}%`;
                }
            } catch (e) {}
        }

        function addLog(type, source, message) {
            const logs = document.getElementById('tab-logs');
            const div = document.createElement('div');
            div.className = 'text-xs font-mono border-l-2 pl-2 py-1 ' + 
                (type === 'error' ? 'border-red-500 text-red-400' : 
                 type === 'success' ? 'border-green-500 text-green-400' : 
                 'border-slate-600 text-slate-400');
            
            div.innerHTML = `
                <span class="font-bold text-slate-500">[${new Date().toLocaleTimeString()}]</span>
                <span class="font-semibold text-slate-300">${source}:</span>
                ${message}
            `;
            logs.prepend(div);
            
            // Show badge if panel closed
            if (document.getElementById('activity-panel').classList.contains('translate-x-full')) {
                document.getElementById('activity-badge').classList.remove('hidden');
            }
        }

        // Start
        document.addEventListener('DOMContentLoaded', checkAuth);

        // File Input
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('attachments-preview');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const base64 = ev.target.result.split(',')[1];
                    attachedFiles.push({
                        name: file.name,
                        type: file.type,
                        data: base64
                    });
                    
                    const tag = document.createElement('div');
                    tag.className = 'bg-slate-800 text-xs text-slate-300 px-2 py-1 rounded-md flex items-center gap-2 border border-slate-700';
                    tag.innerHTML = `
                        <i class="ri-file-text-line"></i>
                        ${file.name}
                        <button onclick="this.parentElement.remove()" class="hover:text-red-400"><i class="ri-close-line"></i></button>
                    `;
                    preview.appendChild(tag);
                };
                reader.readAsDataURL(file);
            });
        });
    </script>
</body>
</html>