<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Orchestrator v2.5 - 4LB.ca</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f0f1a;
            --accent: #00d9ff;
            --accent-dim: rgba(0, 217, 255, 0.1);
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff4444;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: rgba(255, 255, 255, 0.1);
            --sidebar-width: 280px;
            --activity-width: 350px;
        }
        
        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8ecf0;
            --accent: #0077cc;
            --accent-dim: rgba(0, 119, 204, 0.1);
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a6e;
            --border: rgba(0, 0, 0, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }
        
        .container { display: flex; height: 100vh; }
        
        /* === SIDEBAR === */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: background 0.3s;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-header h1 { font-size: 1.1rem; color: var(--accent); }
        .sidebar-header span { font-size: 0.7rem; color: var(--text-secondary); }
        
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .theme-toggle:hover { transform: scale(1.1); }
        
        .new-chat-btn {
            margin: 15px;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .new-chat-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 217, 255, 0.3); }
        
        /* === NAV TABS === */
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 10px;
        }
        .nav-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .nav-tab:hover { color: var(--accent); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .tab-content { flex: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        
        .conversations-list { padding: 10px; }
        
        .conv-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .conv-item:hover { background: var(--accent-dim); }
        .conv-item.active { background: var(--accent-dim); border-left: 3px solid var(--accent); }
        .conv-title { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .conv-delete { opacity: 0; background: none; border: none; color: var(--error); cursor: pointer; }
        .conv-item:hover .conv-delete { opacity: 1; }
        
        /* === DOCKER STATUS === */
        .docker-panel { padding: 15px; }
        .docker-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .docker-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .docker-box:hover { transform: scale(1.02); }
        .docker-box .name { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .docker-box .status { font-size: 1.2rem; }
        .docker-box.running { border-color: var(--success); }
        .docker-box.stopped { border-color: var(--error); }
        
        /* === GIT PANEL === */
        .git-panel { padding: 15px; }
        .git-status { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; }
        .git-branch { 
            display: inline-flex; 
            align-items: center; 
            gap: 5px;
            background: var(--accent-dim); 
            padding: 5px 10px; 
            border-radius: 15px;
            margin-bottom: 10px;
        }
        .git-commits { max-height: 200px; overflow-y: auto; }
        .git-commit {
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 3px solid var(--accent);
        }
        .git-commit .hash { color: var(--warning); font-size: 0.7rem; }
        .git-commit .msg { font-size: 0.8rem; margin-top: 3px; }
        .git-commit .date { font-size: 0.65rem; color: var(--text-secondary); }
        
        /* === FILE TREE === */
        .file-panel { padding: 15px; }
        .file-tree { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; }
        .file-item {
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .file-item:hover { background: var(--accent-dim); }
        .file-item.folder { color: var(--warning); }
        .file-item.file { color: var(--text-secondary); }
        .file-children { margin-left: 15px; display: none; }
        .file-children.open { display: block; }
        
        /* === MAIN === */
        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        /* === STATS BAR ENHANCED === */
        .stats-bar {
            display: flex;
            gap: 15px;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .stat-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 8px 15px;
            min-width: 140px;
            border: 1px solid var(--border);
        }
        .stat-card .label { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 3px; }
        .stat-card .value-row { display: flex; align-items: center; gap: 10px; }
        .stat-card .value { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 1rem; }
        .stat-card .value.good { color: var(--success); }
        .stat-card .value.warn { color: var(--warning); }
        .stat-card .value.bad { color: var(--error); }
        
        /* Sparkline */
        .sparkline {
            width: 60px;
            height: 25px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
        }
        .sparkline .bar {
            flex: 1;
            background: var(--accent);
            border-radius: 1px 1px 0 0;
            min-height: 2px;
            transition: height 0.3s;
        }
        .sparkline .bar.warn { background: var(--warning); }
        .sparkline .bar.bad { background: var(--error); }
        
        /* === HEADER === */
        .header {
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--error); transition: background 0.3s; }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); }
        
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        .model-selector select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .activity-toggle, .terminal-toggle {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        .activity-toggle:hover, .terminal-toggle:hover { background: var(--accent-dim); color: var(--accent); }
        
        /* === MESSAGES === */
        .messages { flex: 1; overflow-y: auto; padding: 20px; }
        
        .message {
            max-width: 85%;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            line-height: 1.6;
            position: relative;
        }
        .message.user {
            background: var(--accent);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.assistant {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .message.system {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            text-align: center;
            max-width: 100%;
            font-size: 0.85rem;
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        .message:hover .copy-btn { opacity: 1; }
        .copy-btn:hover { background: var(--accent); color: white; }
        .copy-btn.copied { background: var(--success); color: #000; }
        
        /* Thinking */
        .thinking {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .thinking-header { display: flex; align-items: center; gap: 10px; color: var(--accent); margin-bottom: 10px; }
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #thinking-steps { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto; }
        .thinking-step { padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid var(--accent); }
        .thinking-step.tool { border-left-color: var(--warning); }
        .thinking-step.result { border-left-color: var(--success); }
        
        /* === INPUT === */
        .input-area {
            padding: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }
        
        .attachments { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .attachment {
            display: flex; align-items: center; gap: 5px;
            padding: 5px 10px; background: var(--bg-tertiary);
            border-radius: 6px; font-size: 0.8rem;
        }
        .attachment button { background: none; border: none; color: var(--error); cursor: pointer; }
        
        .input-row { display: flex; gap: 10px; }
        .input-wrapper {
            flex: 1; display: flex;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .input-wrapper:focus-within { border-color: var(--accent); }
        
        #file-input { display: none; }
        .attach-btn {
            padding: 12px; background: none; border: none;
            color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;
        }
        .attach-btn:hover { color: var(--accent); }
        
        #user-input {
            flex: 1; padding: 12px; background: transparent;
            border: none; color: var(--text-primary);
            font-size: 1rem; resize: none;
            min-height: 44px; max-height: 200px;
        }
        #user-input:focus { outline: none; }
        
        .send-btn {
            padding: 12px 24px; background: var(--accent);
            color: white; border: none; border-radius: 12px;
            cursor: pointer; font-weight: 600; transition: all 0.2s;
        }
        .send-btn:hover { transform: translateY(-2px); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* === TERMINAL === */
        .terminal-panel {
            display: none;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            height: 200px;
            flex-direction: column;
        }
        .terminal-panel.open { display: flex; }
        
        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        .terminal-header span { font-size: 0.8rem; font-weight: 600; }
        .terminal-close { background: none; border: none; color: var(--error); cursor: pointer; font-size: 1.2rem; }
        
        .terminal-output {
            flex: 1;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            overflow-y: auto;
            color: var(--success);
        }
        
        .terminal-input-row {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-secondary);
            gap: 8px;
        }
        .terminal-prompt { color: var(--accent); font-family: 'JetBrains Mono', monospace; }
        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }
        .terminal-input:focus { outline: none; }
        
        /* === ACTIVITY PANEL === */
        .activity-panel {
            width: var(--activity-width);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
        }
        .activity-panel.hidden { transform: translateX(100%); position: absolute; right: 0; }
        
        .activity-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-header h3 { font-size: 0.9rem; color: var(--accent); }
        .clear-activity { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.75rem; }
        .clear-activity:hover { color: var(--error); }
        
        .activity-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .activity-item {
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.75rem;
            border-left: 3px solid var(--border);
        }
        .activity-item.success { border-left-color: var(--success); }
        .activity-item.error { border-left-color: var(--error); }
        .activity-item.tool { border-left-color: var(--warning); }
        .activity-item.info { border-left-color: var(--accent); }
        
        .activity-time { font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 3px; }
        .activity-title { font-weight: 600; margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
        .activity-content {
            color: var(--text-secondary);
            font-size: 0.7rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
        
        /* Code blocks */
        code { font-family: 'JetBrains Mono', monospace; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 0.85em; }
        pre { background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto; margin: 10px 0; position: relative; }
        pre code { background: none; padding: 0; }
        
        /* Responsive */
        @media (max-width: 1200px) { .activity-panel { display: none; } }
        @media (max-width: 768px) {
            .sidebar { position: absolute; left: -100%; z-index: 100; height: 100%; transition: left 0.3s; }
            .sidebar.open { left: 0; }
            .stats-bar { flex-wrap: wrap; }
            .stat-card { min-width: 100px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div>
                    <h1>ü§ñ AI Orchestrator</h1>
                    <span>v2.5 - 4LB.ca</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Changer le th√®me">üåô</button>
            </div>
            <button class="new-chat-btn" onclick="newConversation()">+ Nouvelle conversation</button>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('conversations')">üí¨ Chats</button>
                <button class="nav-tab" onclick="switchTab('docker')">üê≥ Docker</button>
                <button class="nav-tab" onclick="switchTab('git')">üìÇ Git</button>
                <button class="nav-tab" onclick="switchTab('files')">üìÅ Fichiers</button>
            </div>
            
            <!-- Conversations Tab -->
            <div class="tab-content active" id="tab-conversations">
                <div class="conversations-list" id="conversations-list"></div>
            </div>
            
            <!-- Docker Tab -->
            <div class="tab-content" id="tab-docker">
                <div class="docker-panel">
                    <div class="docker-grid" id="docker-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Git Tab -->
            <div class="tab-content" id="tab-git">
                <div class="git-panel">
                    <div class="git-branch" id="git-branch">üåø main</div>
                    <div class="git-commits" id="git-commits">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Files Tab -->
            <div class="tab-content" id="tab-files">
                <div class="file-panel">
                    <div class="file-tree" id="file-tree">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Chat -->
        <main class="main">
            <!-- Stats Bar Enhanced -->
            <div class="stats-bar" id="stats-bar">
                <div class="stat-card">
                    <div class="label">üíª CPU</div>
                    <div class="value-row">
                        <span class="value" id="cpu-value">--%</span>
                        <div class="sparkline" id="cpu-sparkline"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="label">üß† RAM</div>
                    <div class="value-row">
                        <span class="value" id="ram-value">--/--</span>
                        <div class="sparkline" id="ram-sparkline"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="label">üéÆ GPU</div>
                    <div class="value-row">
                        <span class="value" id="gpu-value">--%</span>
                        <div class="sparkline" id="gpu-sparkline"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="label">üê≥ Docker</div>
                    <div class="value-row">
                        <span class="value good" id="docker-value">--/--</span>
                    </div>
                </div>
            </div>
            
            <header class="header">
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">D√©connect√©</span>
                </div>
                <div class="header-actions">
                    <div class="model-selector">
                        <select id="model-select" class="model-select">
                            <option value="auto">ü§ñ AUTO (Cloud rapide)</option>
                            <optgroup label="‚òÅÔ∏è Cloud (Rapides)">
                                <option value="qwen3-coder-cloud">Qwen3 Coder 480B</option>
                                <option value="kimi-k2">Kimi K2 1T</option>
                                <option value="gemini-pro">Gemini 3 Pro</option>
                            </optgroup>
                            <optgroup label="üíª Locaux (Code)">
                                <option value="qwen-coder">Qwen 2.5 Coder 32B</option>
                                <option value="deepseek-coder">DeepSeek Coder 33B</option>
                            </optgroup>
                            <optgroup label="üëÅÔ∏è Vision">
                                <option value="llama-vision">Llama 3.2 Vision 11B</option>
                                <option value="qwen-vision">Qwen3 VL 32B</option>
                            </optgroup>
                            <optgroup label="üõ°Ô∏è Autres">
                                <option value="gpt-safeguard">GPT Safeguard</option>
                            </optgroup>
                        </select>
                    </div>
                    <button class="terminal-toggle" onclick="toggleTerminal()">‚å®Ô∏è Terminal</button>
                    <button class="activity-toggle" onclick="toggleActivityPanel()">üìä Activity Log</button>
                </div>
            </header>
            
            <div class="messages" id="messages">
                <div class="message system">
                    üëã Bienvenue sur AI Orchestrator v2.5 ! 
                    Nouvelles fonctionnalit√©s : graphiques temps r√©el, Docker/Git visuel, terminal int√©gr√©, mode clair/sombre.
                </div>
            </div>
            
            <div id="thinking-container"></div>
            
            <!-- Terminal Panel -->
            <div class="terminal-panel" id="terminal-panel">
                <div class="terminal-header">
                    <span>‚å®Ô∏è Terminal</span>
                    <button class="terminal-close" onclick="toggleTerminal()">√ó</button>
                </div>
                <div class="terminal-output" id="terminal-output">
                    <div>lalpha@server:~$ <span style="color: var(--text-secondary);">Terminal pr√™t</span></div>
                </div>
                <div class="terminal-input-row">
                    <span class="terminal-prompt">$</span>
                    <input type="text" class="terminal-input" id="terminal-input" placeholder="Entrez une commande...">
                </div>
            </div>
            
            <div class="input-area">
                <div class="attachments" id="attachments"></div>
                <div class="input-row">
                    <div class="input-wrapper">
                        <input type="file" id="file-input" multiple>
                        <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                        <textarea id="user-input" placeholder="√âcris ta demande..." rows="1"></textarea>
                    </div>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">Envoyer</button>
                </div>
            </div>
        </main>
        
        <!-- Activity Panel -->
        <aside class="activity-panel" id="activity-panel">
            <div class="activity-header">
                <h3>üìä Activity Log</h3>
                <button class="clear-activity" onclick="clearActivity()">Effacer</button>
            </div>
            <div class="activity-list" id="activity-list"></div>
        </aside>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    
    <script>
        // ==========================================
        // AI ORCHESTRATOR v2.5 - JAVASCRIPT
        // ==========================================
        
        const API_URL = window.location.origin;
        let ws = null;
        let currentConversationId = null;
        let attachedFiles = [];
        let isProcessing = false;
        
        // Sparkline data history (30 points)
        const statsHistory = {
            cpu: [],
            ram: [],
            gpu: []
        };
        const MAX_HISTORY = 20;
        
        // ==========================================
        // THEME TOGGLE
        // ==========================================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        
        // ==========================================
        // TAB NAVIGATION
        // ==========================================
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Refresh data when switching
            if (tabName === 'docker') loadDockerStatus();
            if (tabName === 'git') loadGitStatus();
            if (tabName === 'files') loadFileTree();
        }
        
        // ==========================================
        // SPARKLINES
        // ==========================================
        function createSparkline(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            const maxVal = Math.max(...data, 1);
            
            data.forEach(val => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                const height = (val / 100) * 25;
                bar.style.height = `${Math.max(height, 2)}px`;
                
                if (val > 80) bar.classList.add('bad');
                else if (val > 60) bar.classList.add('warn');
                
                container.appendChild(bar);
            });
        }
        
        function updateSparklines() {
            createSparkline('cpu-sparkline', statsHistory.cpu);
            createSparkline('ram-sparkline', statsHistory.ram);
            createSparkline('gpu-sparkline', statsHistory.gpu);
        }
        
        // ==========================================
        // STATS FETCHING
        // ==========================================
        async function fetchStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                // Update values
                const cpuVal = parseFloat(data.cpu?.percent) || 0;
                const ramUsed = parseFloat(data.memory?.used_gb) || 0;
                const ramTotal = parseFloat(data.memory?.total_gb) || 64;
                const ramPercent = (ramUsed / ramTotal) * 100;
                const gpuVal = parseFloat(data.gpu?.percent) || 0;
                
                document.getElementById('cpu-value').textContent = `${cpuVal.toFixed(1)}%`;
                document.getElementById('cpu-value').className = `value ${cpuVal > 80 ? 'bad' : cpuVal > 60 ? 'warn' : 'good'}`;
                
                document.getElementById('ram-value').textContent = `${ramUsed.toFixed(1)}/${ramTotal.toFixed(0)}`;
                document.getElementById('ram-value').className = `value ${ramPercent > 80 ? 'bad' : ramPercent > 60 ? 'warn' : 'good'}`;
                
                document.getElementById('gpu-value').textContent = `${gpuVal.toFixed(0)}%`;
                document.getElementById('gpu-value').className = `value ${gpuVal > 80 ? 'bad' : gpuVal > 60 ? 'warn' : 'good'}`;
                
                const dockerRunning = data.docker?.running || 0;
                const dockerTotal = data.docker?.total || 0;
                document.getElementById('docker-value').textContent = `${dockerRunning}/${dockerTotal}`;
                document.getElementById('docker-value').className = `value ${dockerRunning === dockerTotal ? 'good' : 'warn'}`;
                
                // Update history
                statsHistory.cpu.push(cpuVal);
                statsHistory.ram.push(ramPercent);
                statsHistory.gpu.push(gpuVal);
                
                if (statsHistory.cpu.length > MAX_HISTORY) statsHistory.cpu.shift();
                if (statsHistory.ram.length > MAX_HISTORY) statsHistory.ram.shift();
                if (statsHistory.gpu.length > MAX_HISTORY) statsHistory.gpu.shift();
                
                updateSparklines();
                
            } catch (e) {
                console.error('Stats fetch error:', e);
            }
        }
        
        // ==========================================
        // DOCKER STATUS
        // ==========================================
        async function loadDockerStatus() {
            const grid = document.getElementById('docker-grid');
            grid.innerHTML = '<div style="color: var(--text-secondary); padding: 20px;">Chargement...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const data = await response.json();
                
                const running = data.docker?.running || 0;
                const total = data.docker?.total || 0;
                
                // Containers connus de unified-stack
                const containers = [
                    'traefik', 'postgres', 'redis', 'open-webui',
                    'ai-orchestrator-backend', 'ai-orchestrator-frontend',
                    'chromadb', 'prometheus', 'grafana', 'node-exporter',
                    'cadvisor', 'jsr-dev', 'jsr-solutions', 'code-server'
                ];
                
                grid.innerHTML = '';
                containers.slice(0, total).forEach((name, i) => {
                    const isRunning = i < running;
                    const box = document.createElement('div');
                    box.className = `docker-box ${isRunning ? 'running' : 'stopped'}`;
                    box.innerHTML = `
                        <div class="status">${isRunning ? '‚úÖ' : '‚ùå'}</div>
                        <div class="name">${name}</div>
                    `;
                    box.onclick = () => {
                        document.getElementById('user-input').value = `Montre les logs de ${name}`;
                        sendMessage();
                    };
                    grid.appendChild(box);
                });
            } catch (e) {
                grid.innerHTML = '<div style="color: var(--error);">Erreur de chargement</div>';
            }
        }
        
        // ==========================================
        // GIT STATUS
        // ==========================================
        async function loadGitStatus() {
            const commitsEl = document.getElementById('git-commits');
            const branchEl = document.getElementById('git-branch');
            
            branchEl.innerHTML = 'üåø main';
            commitsEl.innerHTML = `
                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 10px;">
                    Utilise le chat pour voir l'historique git complet.
                </div>
                <button onclick="document.getElementById('user-input').value='git_log du repo ai-tools'; sendMessage();" 
                        style="background: var(--accent-dim); border: 1px solid var(--accent); color: var(--accent); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                    üìú Voir l'historique Git
                </button>
                <button onclick="document.getElementById('user-input').value='git_status du repo ai-tools'; sendMessage();" 
                        style="background: var(--accent-dim); border: 1px solid var(--accent); color: var(--accent); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 8px;">
                    üìä Voir le statut Git
                </button>
            `;
        }
        
        // ==========================================
        // FILE TREE
        // ==========================================
        async function loadFileTree() {
            const tree = document.getElementById('file-tree');
            tree.innerHTML = `
                <div class="file-item folder" onclick="toggleFolder(this)">üìÅ ai-tools</div>
                <div class="file-children">
                    <div class="file-item folder" onclick="toggleFolder(this)">üìÅ ai-orchestrator</div>
                    <div class="file-children">
                        <div class="file-item folder">üìÅ backend</div>
                        <div class="file-item folder">üìÅ frontend</div>
                    </div>
                    <div class="file-item folder">üìÅ mcp-servers</div>
                </div>
                <div class="file-item folder" onclick="toggleFolder(this)">üìÅ infrastructure</div>
                <div class="file-children">
                    <div class="file-item folder">üìÅ unified-stack</div>
                </div>
                <div class="file-item folder" onclick="toggleFolder(this)">üìÅ clients</div>
                <div class="file-children">
                    <div class="file-item folder">üìÅ jsr</div>
                </div>
            `;
        }
        
        function toggleFolder(el) {
            const children = el.nextElementSibling;
            if (children && children.classList.contains('file-children')) {
                children.classList.toggle('open');
                el.textContent = el.textContent.replace('üìÅ', children.classList.contains('open') ? 'üìÇ' : 'üìÅ');
            }
        }
        
        // ==========================================
        // TERMINAL
        // ==========================================
        function toggleTerminal() {
            const panel = document.getElementById('terminal-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                document.getElementById('terminal-input').focus();
            }
        }
        
        document.getElementById('terminal-input')?.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const input = e.target;
                const command = input.value.trim();
                if (!command) return;
                
                const output = document.getElementById('terminal-output');
                output.innerHTML += `<div><span style="color: var(--accent);">$</span> ${command}</div>`;
                input.value = '';
                
                try {
                    // Send command via chat API
                    const response = await fetch(`${API_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: `execute_command: ${command}`,
                            model: 'auto'
                        })
                    });
                    const data = await response.json();
                    output.innerHTML += `<div style="color: var(--text-secondary);">${data.response || 'Commande ex√©cut√©e'}</div>`;
                } catch (err) {
                    output.innerHTML += `<div style="color: var(--error);">Erreur: ${err.message}</div>`;
                }
                
                output.scrollTop = output.scrollHeight;
            }
        });
        
        // ==========================================
        // ACTIVITY PANEL
        // ==========================================
        function toggleActivityPanel() {
            const panel = document.getElementById('activity-panel');
            panel.classList.toggle('hidden');
        }
        
        function addActivity(type, title, content) {
            const list = document.getElementById('activity-list');
            const item = document.createElement('div');
            item.className = `activity-item ${type}`;
            item.innerHTML = `
                <div class="activity-time">${new Date().toLocaleTimeString()}</div>
                <div class="activity-title">${title}</div>
                <div class="activity-content">${content}</div>
            `;
            list.insertBefore(item, list.firstChild);
            
            // Keep only last 50 items
            while (list.children.length > 50) {
                list.removeChild(list.lastChild);
            }
        }
        
        function clearActivity() {
            document.getElementById('activity-list').innerHTML = '';
        }
        
        // ==========================================
        // WEBSOCKET CONNECTION
        // ==========================================
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/chat`);
            
            ws.onopen = () => {
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-text').textContent = 'Connect√©';
                addActivity('info', 'üü¢ WebSocket connect√©', 'Pr√™t √† recevoir des commandes');
            };
            
            ws.onclose = () => {
                document.getElementById('status-dot').classList.remove('connected');
                document.getElementById('status-text').textContent = 'D√©connect√©';
                addActivity('error', 'üî¥ WebSocket d√©connect√©', 'Tentative de reconnexion...');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addActivity('error', '‚ùå Erreur WebSocket', error.message || 'Erreur de connexion');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };
        }
        
        function handleWebSocketMessage(data) {
            console.log('üì® WS Message:', data.type, data);
            
            switch (data.type) {
                case 'model_selected':
                    document.getElementById('model-select').value = data.model.includes('vision') ? 'vision' : 'auto';
                    addActivity('info', 'ü§ñ Mod√®le s√©lectionn√©', data.model);
                    break;
                    
                case 'conversation_created':
                    currentConversationId = data.conversation_id;
                    addActivity('info', 'üí¨ Conversation cr√©√©e', data.conversation_id);
                    break;
                    
                case 'thinking':
                    showThinking(data.iteration);
                    addActivity('info', `üîÑ It√©ration ${data.iteration}`, data.message || 'Analyse en cours...');
                    break;
                    
                case 'step':
                    updateThinking(data.content);
                    addActivity('info', `üìù √âtape ${data.iteration}`, data.content?.slice(0, 200) || '');
                    break;
                    
                case 'tool':
                    updateThinking(`üîß ${data.tool}(${JSON.stringify(data.params).slice(0, 100)}...)`);
                    addActivity('tool', `‚ö° Ex√©cution: ${data.tool}`, JSON.stringify(data.params, null, 2));
                    break;
                    
                case 'result':
                    updateThinking(`‚úÖ R√©sultat de ${data.tool}`);
                    addActivity('success', `‚úÖ R√©sultat: ${data.tool}`, data.result?.slice(0, 500) || '');
                    break;
                    
                case 'complete':
                    hideThinking();
                    addMessage('assistant', data.answer);
                    addActivity('success', '‚úÖ R√©ponse compl√®te', `${data.iterations} it√©rations`);
                    isProcessing = false;
                    document.getElementById('send-btn').disabled = false;
                    loadConversations();
                    break;
                    
                case 'error':
                    hideThinking();
                    addMessage('system', `‚ùå Erreur: ${data.message || data.content}`);
                    addActivity('error', '‚ùå Erreur', data.message || data.content);
                    isProcessing = false;
                    document.getElementById('send-btn').disabled = false;
                    break;
                    
                default:
                    console.log('Type non g√©r√©:', data.type);
            }
        }
        
        // ==========================================
        // THINKING INDICATOR
        // ==========================================
        function showThinking(iteration) {
            let container = document.getElementById('thinking-container');
            container.innerHTML = `
                <div class="thinking">
                    <div class="thinking-header">
                        <div class="spinner"></div>
                        <span>It√©ration ${iteration} - Analyse en cours...</span>
                    </div>
                    <div id="thinking-steps"></div>
                </div>
            `;
        }
        
        function updateThinking(step) {
            const steps = document.getElementById('thinking-steps');
            if (steps) {
                const stepEl = document.createElement('div');
                stepEl.className = 'thinking-step';
                if (step.includes('üîß')) stepEl.classList.add('tool');
                if (step.includes('‚úÖ')) stepEl.classList.add('result');
                stepEl.textContent = step;
                steps.appendChild(stepEl);
                steps.scrollTop = steps.scrollHeight;
            }
        }
        
        function hideThinking() {
            document.getElementById('thinking-container').innerHTML = '';
        }
        
        // ==========================================
        // MESSAGES
        // ==========================================
        function addMessage(role, content) {
            const messages = document.getElementById('messages');
            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            
            // Process markdown and code blocks
            let processedContent = content
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const language = lang || 'plaintext';
                    return `<pre><code class="language-${language}">${escapeHtml(code.trim())}</code></pre>`;
                })
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            msg.innerHTML = processedContent;
            
            // Add copy button for assistant messages
            if (role === 'assistant') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'üìã Copier';
                copyBtn.onclick = () => copyToClipboard(content, copyBtn);
                msg.appendChild(copyBtn);
            }
            
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
            
            // Highlight code
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(msg);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = '‚úÖ Copi√©!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'üìã Copier';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
        
        // ==========================================
        // SEND MESSAGE
        // ==========================================
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            isProcessing = true;
            document.getElementById('send-btn').disabled = true;
            
            addMessage('user', message);
            addActivity('info', 'üì§ Message envoy√©', message);
            input.value = '';
            input.style.height = 'auto';
            
            // Send via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                const payload = {
                    message: message,
                    model: document.getElementById('model-select').value,
                    conversation_id: currentConversationId,
                    file_ids: attachedFiles
                };
                console.log('üì§ Sending payload:', payload);
                ws.send(JSON.stringify(payload));
                attachedFiles = [];
                document.getElementById('attachments').innerHTML = '';
            } else {
                addMessage('system', '‚ùå WebSocket non connect√©');
                isProcessing = false;
                document.getElementById('send-btn').disabled = false;
            }
        }
        
        // ==========================================
        // FILE UPLOAD
        // ==========================================
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = e.target.files;
            const attachmentsEl = document.getElementById('attachments');
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const base64 = ev.target.result.split(',')[1];
                    attachedFiles.push({
                        name: file.name,
                        type: file.type,
                        data: base64
                    });
                    
                    const attach = document.createElement('div');
                    attach.className = 'attachment';
                    attach.innerHTML = `
                        <span>üìé ${file.name}</span>
                        <button onclick="removeAttachment('${file.name}', this)">√ó</button>
                    `;
                    attachmentsEl.appendChild(attach);
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        });
        
        function removeAttachment(name, btn) {
            attachedFiles = attachedFiles.filter(f => f.name !== name);
            btn.parentElement.remove();
        }
        
        // ==========================================
        // CONVERSATIONS
        // ==========================================
        async function loadConversations() {
            try {
                const response = await fetch(`${API_URL}/api/conversations`);
                const conversations = await response.json();
                
                const list = document.getElementById('conversations-list');
                list.innerHTML = '';
                
                conversations.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = `conv-item ${conv.id === currentConversationId ? 'active' : ''}`;
                    item.innerHTML = `
                        <span class="conv-title">${conv.title || 'Nouvelle conversation'}</span>
                        <button class="conv-delete" onclick="deleteConversation('${conv.id}', event)">üóëÔ∏è</button>
                    `;
                    item.onclick = () => loadConversation(conv.id);
                    list.appendChild(item);
                });
            } catch (e) {
                console.error('Load conversations error:', e);
            }
        }
        
        async function loadConversation(id) {
            currentConversationId = id;
            try {
                const response = await fetch(`${API_URL}/api/conversations/${id}`);
                const conv = await response.json();
                
                const messages = document.getElementById('messages');
                messages.innerHTML = '<div class="message system">üí¨ Conversation charg√©e</div>';
                
                conv.messages?.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
                
                loadConversations();
            } catch (e) {
                console.error('Load conversation error:', e);
            }
        }
        
        function newConversation() {
            currentConversationId = null;
            document.getElementById('messages').innerHTML = `
                <div class="message system">
                    üëã Nouvelle conversation ! Comment puis-je t'aider ?
                </div>
            `;
            loadConversations();
        }
        
        async function deleteConversation(id, event) {
            event.stopPropagation();
            if (!confirm('Supprimer cette conversation ?')) return;
            
            try {
                await fetch(`${API_URL}/api/conversations/${id}`, { method: 'DELETE' });
                if (id === currentConversationId) {
                    newConversation();
                }
                loadConversations();
            } catch (e) {
                console.error('Delete error:', e);
            }
        }
        
        // ==========================================
        // INPUT HANDLING
        // ==========================================
        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('user-input').addEventListener('input', (e) => {
            e.target.style.height = 'auto';
            e.target.style.height = Math.min(e.target.scrollHeight, 200) + 'px';
        });
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            loadConversations();
            fetchStats();
            
            // Fetch stats every 5 seconds
            setInterval(fetchStats, 5000);
            
            // Keyboard shortcut: Ctrl+Enter to send
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
