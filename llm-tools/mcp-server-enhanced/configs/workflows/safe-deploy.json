{
  "name": "safe-deploy",
  "description": "Déploiement sécurisé avec backup automatique et rollback en cas d'échec",
  "steps": [
    {
      "name": "Backup pré-déploiement",
      "type": "task",
      "task": "create-restore-point",
      "params": {
        "backup_name": "pre-deploy"
      },
      "output": "backup_result"
    },
    {
      "name": "Tests pré-déploiement",
      "type": "command",
      "command": "php",
      "args": ["artisan", "test"],
      "working_directory": "/home/studiosdb/studiosunisdb/studiosdb",
      "output": "test_result"
    },
    {
      "name": "Pull des changements",
      "type": "command",
      "command": "git",
      "args": ["pull", "origin", "main"],
      "working_directory": "/home/studiosdb/studiosunisdb",
      "output": "git_result"
    },
    {
      "name": "Installation des dépendances",
      "type": "parallel",
      "tasks": [
        {
          "command": "composer",
          "args": ["install", "--no-dev", "--optimize-autoloader"],
          "working_directory": "/home/studiosdb/studiosunisdb/studiosdb"
        },
        {
          "command": "npm",
          "args": ["ci"],
          "working_directory": "/home/studiosdb/studiosunisdb/studiosdb"
        }
      ]
    },
    {
      "name": "Build des assets",
      "type": "command",
      "command": "npm",
      "args": ["run", "build"],
      "working_directory": "/home/studiosdb/studiosunisdb/studiosdb",
      "output": "build_result"
    },
    {
      "name": "Migrations",
      "type": "command",
      "command": "php",
      "args": ["artisan", "migrate", "--force"],
      "working_directory": "/home/studiosdb/studiosunisdb/studiosdb",
      "output": "migration_result"
    },
    {
      "name": "Optimisation Laravel",
      "type": "parallel",
      "tasks": [
        {
          "command": "php",
          "args": ["artisan", "config:cache"],
          "working_directory": "/home/studiosdb/studiosunisdb/studiosdb"
        },
        {
          "command": "php",
          "args": ["artisan", "route:cache"],
          "working_directory": "/home/studiosdb/studiosunisdb/studiosdb"
        },
        {
          "command": "php",
          "args": ["artisan", "view:cache"],
          "working_directory": "/home/studiosdb/studiosunisdb/studiosdb"
        }
      ]
    },
    {
      "name": "Health check",
      "type": "command",
      "command": "curl",
      "args": ["-f", "http://localhost/health"],
      "output": "health_result"
    }
  ],
  "on_error": {
    "action": "rollback",
    "task": "rollback-system",
    "params": {
      "backup_id": "{{backup_result.backupId}}"
    }
  },
  "on_success": {
    "notifications": [
      {
        "type": "log",
        "message": "Déploiement réussi avec backup {{backup_result.backupId}}"
      }
    ]
  }
}